<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Factory Explorer</title>
</head>
<body>
    <h1>Contract Factory Explorer</h1>
    <a href="dump.html">dump</a>
    <label for="chain-select">Select Chain:</label>
    <select id="chain-select">
        <option value="ethereum">Ethereum (default)</option>
        <option value="polygon">Polygon</option>
        <option value="arbitrum">Arbitrum</option>
        <option value="avalanche">Avalanche</option>
        <!-- <option value="mantle">Mantle</option> -->
    </select>
    <div id="factory-address"></div>
    <div id="factory-name"></div>
    <div id="factory-version"></div>
    <div id="factory-owner"></div>
    <div id="factory-pending-owner"></div>
    <div id="implementation"></div>
    <div id="contracts-list"></div>

    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
        type="application/javascript"></script>

        <script>
            // import data from './abi/CoboFactory.json'
        console.log("JavaScript is running!");
        const factoryABI = [
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "_owner",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "nonpayable",
                            "type": "constructor"
                        },
                        {
                            "anonymous": false,
                            "inputs": [
                            {
                                "indexed": true,
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            },
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "implementation",
                                "type": "address"
                            }
                            ],
                            "name": "ImplementationAdded",
                            "type": "event"
                        },
                        {
                            "anonymous": false,
                            "inputs": [
                            {
                                "indexed": false,
                                "internalType": "address",
                                "name": "owner",
                                "type": "address"
                            }
                            ],
                            "name": "NewOwnerSet",
                            "type": "event"
                        },
                        {
                            "anonymous": false,
                            "inputs": [
                            {
                                "indexed": false,
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            }
                            ],
                            "name": "PendingOwnerSet",
                            "type": "event"
                        },
                        {
                            "anonymous": false,
                            "inputs": [
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "deployer",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            },
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "implementation",
                                "type": "address"
                            },
                            {
                                "indexed": false,
                                "internalType": "address",
                                "name": "proxy",
                                "type": "address"
                            }
                            ],
                            "name": "ProxyCreated",
                            "type": "event"
                        },
                        {
                            "inputs": [],
                            "name": "NAME",
                            "outputs": [
                            {
                                "internalType": "bytes32",
                                "name": "",
                                "type": "bytes32"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [],
                            "name": "VERSION",
                            "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [],
                            "name": "_NAME",
                            "outputs": [
                            {
                                "internalType": "string",
                                "name": "",
                                "type": "string"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [],
                            "name": "acceptOwner",
                            "outputs": [],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "impl",
                                "type": "address"
                            }
                            ],
                            "name": "addImplementation",
                            "outputs": [],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            }
                            ],
                            "name": "create",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "instance",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            },
                            {
                                "internalType": "bytes32",
                                "name": "salt",
                                "type": "bytes32"
                            }
                            ],
                            "name": "create2",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "instance",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            },
                            {
                                "internalType": "bytes32",
                                "name": "salt",
                                "type": "bytes32"
                            }
                            ],
                            "name": "create2AndRecord",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "instance",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            }
                            ],
                            "name": "createAndRecord",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "instance",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            }
                            ],
                            "name": "getAllImplementations",
                            "outputs": [
                            {
                                "internalType": "address[]",
                                "name": "impls",
                                "type": "address[]"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [],
                            "name": "getAllNames",
                            "outputs": [
                            {
                                "internalType": "bytes32[]",
                                "name": "_names",
                                "type": "bytes32[]"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "deployer",
                                "type": "address"
                            },
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            }
                            ],
                            "name": "getAllRecord",
                            "outputs": [
                            {
                                "internalType": "address[]",
                                "name": "proxies",
                                "type": "address[]"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "creator",
                                "type": "address"
                            },
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            },
                            {
                                "internalType": "bytes32",
                                "name": "salt",
                                "type": "bytes32"
                            }
                            ],
                            "name": "getCreate2Address",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "instance",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "deployer",
                                "type": "address"
                            },
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            }
                            ],
                            "name": "getLastRecord",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "proxy",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            }
                            ],
                            "name": "getLatestImplementation",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "impl",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "deployer",
                                "type": "address"
                            },
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            }
                            ],
                            "name": "getRecordSize",
                            "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "size",
                                "type": "uint256"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "deployer",
                                "type": "address"
                            },
                            {
                                "internalType": "bytes32",
                                "name": "name",
                                "type": "bytes32"
                            },
                            {
                                "internalType": "uint256",
                                "name": "start",
                                "type": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "end",
                                "type": "uint256"
                            }
                            ],
                            "name": "getRecords",
                            "outputs": [
                            {
                                "internalType": "address[]",
                                "name": "proxies",
                                "type": "address[]"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "",
                                "type": "bytes32"
                            },
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                            ],
                            "name": "implementations",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "_owner",
                                "type": "address"
                            }
                            ],
                            "name": "initialize",
                            "outputs": [],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "",
                                "type": "bytes32"
                            }
                            ],
                            "name": "latestImplementations",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                            ],
                            "name": "names",
                            "outputs": [
                            {
                                "internalType": "bytes32",
                                "name": "",
                                "type": "bytes32"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [],
                            "name": "owner",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [],
                            "name": "pendingOwner",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            },
                            {
                                "internalType": "bytes32",
                                "name": "",
                                "type": "bytes32"
                            },
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                            ],
                            "name": "records",
                            "outputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [],
                            "name": "renounceOwnership",
                            "outputs": [],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            }
                            ],
                            "name": "setPendingOwner",
                            "outputs": [],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [
                            {
                                "internalType": "address",
                                "name": "newOwner",
                                "type": "address"
                            }
                            ],
                            "name": "transferOwnership",
                            "outputs": [],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        }
                        ];
        // factoryABI=data;
                        const factoryAddress = "0xC0B00000e19D71fA50a9BB1fcaC2eC92fac9549C";

        function s32(data) {
            const decoder = new TextDecoder('utf-8');
            const sliced = data.slice(2);
            const arr = new Uint8Array(sliced.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
            const decoded = decoder.decode(arr);
            return decoded
        }
        
        async function getFactoryData(chain) {
            try {
                const provider = new ethers.providers.JsonRpcProvider(getProviderUrl(chain));
        
                const factoryContract = new ethers.Contract(factoryAddress, factoryABI, provider);
                const contractName = await factoryContract.NAME();
                document.getElementById('factory-name').innerText = `Factory Name: ${s32(contractName)}`;
                document.getElementById('factory-address').innerText = `Factory Address: ${factoryAddress}`;
                const factoryVersion = factoryContract.VERSION();
                console.log("Version:", factoryVersion)
                factoryVersion.then((value) => {
                    document.getElementById('factory-version').innerText = `Factory Version: ${value.toHexString()}`;
                }).catch((error) => {
                    console.error("Error:", error);
                });
                try {
                    const factoryOwner = factoryContract.owner()
                    factoryOwner.then((value) => {
                        document.getElementById('factory-owner').innerText = `Factory Owner: ${value}`;
                    }).catch((error) => {
                        console.error("Error:", error);
                    });
                    const factoryPendingOwner = factoryContract.pendingOwner();
                    factoryPendingOwner.then((value) => {
                        if (value !== "0x0000000000000000000000000000000000000000") {
                            document.getElementById('factory-pending-owner').innerText = `Factory Pending Owner: ${value}`;
                        }
                    }).catch((error) => {
                        console.error("Error:", error);
                    });
                } catch (error) {
                    console.error(error);
                }

                const contractNames = await factoryContract.getAllNames();
                document.getElementById('factory-pending-owner').innerHTML =  `<h3>Latest implementations (Total ${contractNames.length}):<h3>`;
                const contractsList = document.getElementById('contracts-list');
                contractsList.innerHTML = '';
                const promises = contractNames.map(async (name) => {
                    const contractAddress = await factoryContract.getLatestImplementation(name);
                    
                    return { name, address: contractAddress };
                });
                Promise.all(promises)
                    .then((results) => {
                        results.forEach(({ name, address }) => {
                            const contractDiv = document.createElement('div');
                            console.log(s32(name));
                            console.log(address);
                            contractDiv.innerText = `${s32(name)}: ${address}`;
                            
                            contractsList.appendChild(contractDiv);
                        });
                    })
                    .catch((error) => {
                        console.error(error);
                    });

            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function getProviderUrl(chain) {
            switch (chain) {
                case 'ethereum':
                    return "https://rpc.ankr.com/eth";
                case 'polygon':
                    return "https://rpc.ankr.com/polygon";
                case 'arbitrum':
                    return "https://rpc.ankr.com/arbitrum"
                case 'avalanche':
                    return "https://rpc.ankr.com/avalanche"  
                // case 'mantle':
                //     return "https://rpc.ankr.com/mantle"  
                default:
                    throw new Error('Unsupported chain');
            }
        }
        
        document.getElementById('chain-select').addEventListener('change', (event) => {
            const selectedChain = event.target.value;
            console.log(selectedChain);
            getFactoryData(selectedChain);
        });
        
        getFactoryData('ethereum');
        </script>
</body>
</html>
